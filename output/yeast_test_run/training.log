2025-06-05 15:36:03,321 - INFO - 开始训练，配置：
{'stage': 'fit', 'type': 'region', 'assembly': 'hg38', 'eval_tss': False, 'log_image': False, 'experiment': {'name': 'yeast_lora_finetuning', 'seed': 42, 'debug': True}, 'training': {'batch_size': 8, 'num_workers': 1, 'learning_rate': 0.0001, 'weight_decay': 0.0001, 'max_epochs': 1, 'early_stopping_patience': 2, 'gradient_clip_val': 1.0, 'use_lora': True, 'lora_rank': 2, 'lora_alpha': 8, 'lora_layers': ['encoder', 'head_exp'], 'save_every_n_epochs': 1, 'accumulate_grad_batches': 1, 'clip_grad': None, 'use_fp16': False, 'log_every_n_steps': 1, 'val_check_interval': 1.0, 'warmup_epochs': 0}, 'data': {'data_path': 'input/20250601_data/yeast_data_with_conditions_original_peaks.zarr'}, 'model': {'_target_': 'get_model.model.yeast_model.YeastModel', 'cfg': {'num_regions': 2268, 'num_motif': 283, 'embed_dim': 256, 'num_layers': 3, 'num_heads': 8, 'dropout': 0.1, 'output_dim': 1, 'flash_attn': False, 'pool_method': 'mean', 'region_embed': {'num_regions': '${model.cfg.num_regions}', 'num_features': '${model.cfg.num_motif}', 'embed_dim': '${model.cfg.embed_dim}'}, 'encoder': {'num_heads': '${model.cfg.num_heads}', 'embed_dim': '${model.cfg.embed_dim}', 'num_layers': '${model.cfg.num_layers}', 'drop_path_rate': '${model.cfg.dropout}', 'drop_rate': 0, 'attn_drop_rate': 0, 'use_mean_pooling': False, 'flash_attn': '${model.cfg.flash_attn}'}, 'head_exp': {'embed_dim': '${model.cfg.embed_dim}', 'output_dim': '${model.cfg.output_dim}', 'use_atac': False}, 'loss': {'components': {'exp': {'_target_': 'torch.nn.PoissonNLLLoss', 'reduction': 'mean', 'log_input': False}}, 'weights': {'exp': 1.0}}, 'metrics': {'components': {'exp': ['pearson', 'spearman', 'r2']}}}, 'model': {'name': 'yeast_model', 'type': 'transformer', 'feature_encoders': {'media_type': {'type': 'embedding', 'num_embeddings': 2, 'embedding_dim': 32, 'padding_idx': None}, 'temperature': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'pre_culture': {'time': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'od600': {'type': 'linear', 'in_features': 1, 'out_features': 32}}, 'drug_culture': {'time': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'drug_name': {'type': 'embedding', 'num_embeddings': 100, 'embedding_dim': 32, 'padding_idx': 0}, 'concentration': {'type': 'linear', 'in_features': 1, 'out_features': 32}}, 'carbon_source': {'type': 'embedding', 'num_embeddings': 10, 'embedding_dim': 32, 'padding_idx': 0}, 'nitrogen_source': {'type': 'embedding', 'num_embeddings': 10, 'embedding_dim': 32, 'padding_idx': 0}}, 'feature_fusion': {'type': 'concat', 'fusion_dim': 256, 'hidden_dim': 128, 'num_layers': 2, 'dropout': 0.1}, 'transformer': {'num_layers': 3, 'num_heads': 4, 'hidden_dim': 128, 'dropout': 0.1, 'activation': 'gelu', 'layer_norm_eps': 1e-05}, 'prediction_head': {'type': 'mlp', 'hidden_dims': [128, 64], 'dropout': 0.1, 'activation': 'relu', 'output_dim': 1}, 'loss': {'type': 'mse', 'reduction': 'mean'}, 'optimizer': {'type': 'adam', 'lr': 0.001, 'weight_decay': 0.0001, 'betas': [0.9, 0.999], 'eps': 1e-08}, 'scheduler': {'type': 'cosine', 'T_max': 100, 'eta_min': 1e-06}}}, 'finetune': {'pretrain_checkpoint': True, 'checkpoint': 'checkpoints/fetal_pretrain_fetal_finetune/Astrocytes/checkpoint-best.pth', 'strict': False, 'model_key': 'state_dict', 'use_lora': True, 'lora_checkpoint': None, 'rename_config': None, 'layers_with_lora': ['encoder', 'head_exp'], 'patterns_to_freeze': [], 'patterns_to_drop': [], 'additional_checkpoints': []}, 'logging': {'save_dir': 'output/yeast_test_run', 'tensorboard': False, 'wandb': False, 'project_name': 'yeast_test', 'run_name': 'test_run', 'use_wandb': False}, 'machine': {'output_dir': 'output', 'num_devices': 1}, 'optimizer': {'lr': 0.0001, 'min_lr': 1e-06, 'weight_decay': 0.05, 'opt': 'adamw', 'opt_eps': 1e-08, 'opt_betas': [0.9, 0.999]}, 'task': {'test_mode': 'normal', 'interpret': False, 'save_predictions': False, 'save_embeddings': False}, 'dataset': {'_target_': 'get_model.data.yeast_dataset.YeastZarrDataset', 'zarr_path': '/home/rhyswei/Code/aiyeast/get_model/input/20250601_data/yeast_data_with_conditions_original_peaks.zarr', 'split': 'train', 'batch_size': 8, 'shuffle': True, 'num_workers': 1}}
2025-06-05 15:36:03,321 - INFO - 使用设备: cpu
2025-06-05 15:36:03,349 - INFO - 数据加载完成，批次大小: 8
2025-06-05 15:36:03,352 - INFO - 模型初始化完成
2025-06-05 15:36:04,525 - INFO - 开始训练...
2025-06-05 15:36:04,876 - INFO - Epoch 1/1, Batch 0/9, Loss: 7550358.5000
2025-06-05 15:36:05,218 - INFO - Epoch 1/1, Batch 1/9, Loss: 6481876.5000
2025-06-05 15:36:14,046 - INFO - Epoch 1/1, Batch 2/9, Loss: 7964460.0000
2025-06-05 15:36:05,262 - INFO - Epoch 1/1, Batch 3/9, Loss: 7782238.5000
2025-06-05 15:36:05,523 - INFO - Epoch 1/1, Batch 4/9, Loss: 4007435.2500
2025-06-05 15:36:05,785 - INFO - Epoch 1/1, Batch 5/9, Loss: 3789673.2500
2025-06-05 15:36:06,039 - INFO - Epoch 1/1, Batch 6/9, Loss: 9187729.0000
2025-06-05 15:36:06,290 - INFO - Epoch 1/1, Batch 7/9, Loss: 4044264.0000
2025-06-05 15:36:06,356 - INFO - Epoch 1/1, Batch 8/9, Loss: 7839113.0000
2025-06-05 15:36:06,370 - INFO - Epoch 1/1, Average Loss: 6516349.7778
2025-06-05 15:36:06,383 - INFO - 保存检查点到: output/yeast_test_run/checkpoint_epoch_1.pth
2025-06-05 15:36:06,387 - INFO - 训练完成，最终模型保存到: output/yeast_test_run/final_model.pth
2025-06-05 15:39:02,657 - INFO - 开始训练，配置：
{'stage': 'fit', 'type': 'region', 'assembly': 'hg38', 'eval_tss': False, 'log_image': False, 'experiment': {'name': 'yeast_lora_finetuning', 'seed': 42, 'debug': True}, 'training': {'batch_size': 8, 'num_workers': 1, 'learning_rate': 0.0001, 'weight_decay': 0.0001, 'max_epochs': 1, 'early_stopping_patience': 2, 'gradient_clip_val': 1.0, 'use_lora': True, 'lora_rank': 2, 'lora_alpha': 8, 'lora_layers': ['encoder', 'head_exp'], 'save_every_n_epochs': 1, 'accumulate_grad_batches': 1, 'clip_grad': None, 'use_fp16': False, 'log_every_n_steps': 1, 'val_check_interval': 1.0, 'warmup_epochs': 0}, 'data': {'data_path': 'input/20250601_data/yeast_data_with_conditions_original_peaks.zarr'}, 'model': {'_target_': 'get_model.model.yeast_model.YeastModel', 'cfg': {'num_regions': 2268, 'num_motif': 283, 'embed_dim': 256, 'num_layers': 3, 'num_heads': 4, 'dropout': 0.1, 'output_dim': 1, 'flash_attn': False, 'pool_method': 'mean', 'region_embed': {'num_regions': '${model.cfg.num_regions}', 'num_features': '${model.cfg.num_motif}', 'embed_dim': '${model.cfg.embed_dim}'}, 'encoder': {'num_heads': '${model.cfg.num_heads}', 'embed_dim': '${model.cfg.embed_dim}', 'num_layers': '${model.cfg.num_layers}', 'drop_path_rate': '${model.cfg.dropout}', 'drop_rate': 0, 'attn_drop_rate': 0, 'use_mean_pooling': False, 'flash_attn': '${model.cfg.flash_attn}'}, 'head_exp': {'embed_dim': '${model.cfg.embed_dim}', 'output_dim': '${model.cfg.output_dim}', 'use_atac': False}, 'loss': {'components': {'exp': {'_target_': 'torch.nn.PoissonNLLLoss', 'reduction': 'mean', 'log_input': False}}, 'weights': {'exp': 1.0}}, 'metrics': {'components': {'exp': ['pearson', 'spearman', 'r2']}}}, 'model': {'name': 'yeast_model', 'type': 'transformer', 'feature_encoders': {'media_type': {'type': 'embedding', 'num_embeddings': 2, 'embedding_dim': 32, 'padding_idx': None}, 'temperature': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'pre_culture': {'time': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'od600': {'type': 'linear', 'in_features': 1, 'out_features': 32}}, 'drug_culture': {'time': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'drug_name': {'type': 'embedding', 'num_embeddings': 100, 'embedding_dim': 32, 'padding_idx': 0}, 'concentration': {'type': 'linear', 'in_features': 1, 'out_features': 32}}, 'carbon_source': {'type': 'embedding', 'num_embeddings': 10, 'embedding_dim': 32, 'padding_idx': 0}, 'nitrogen_source': {'type': 'embedding', 'num_embeddings': 10, 'embedding_dim': 32, 'padding_idx': 0}}, 'feature_fusion': {'type': 'concat', 'fusion_dim': 256, 'hidden_dim': 128, 'num_layers': 2, 'dropout': 0.1}, 'transformer': {'num_layers': 3, 'num_heads': 4, 'hidden_dim': 128, 'dropout': 0.1, 'activation': 'gelu', 'layer_norm_eps': 1e-05}, 'prediction_head': {'type': 'mlp', 'hidden_dims': [128, 64], 'dropout': 0.1, 'activation': 'relu', 'output_dim': 1}, 'loss': {'type': 'mse', 'reduction': 'mean'}, 'optimizer': {'type': 'adam', 'lr': 0.001, 'weight_decay': 0.0001, 'betas': [0.9, 0.999], 'eps': 1e-08}, 'scheduler': {'type': 'cosine', 'T_max': 100, 'eta_min': 1e-06}}}, 'finetune': {'pretrain_checkpoint': True, 'checkpoint': 'checkpoints/fetal_pretrain_fetal_finetune/Astrocytes/checkpoint-best.pth', 'strict': False, 'model_key': 'state_dict', 'use_lora': True, 'lora_checkpoint': None, 'rename_config': None, 'layers_with_lora': ['encoder', 'head_exp'], 'patterns_to_freeze': [], 'patterns_to_drop': [], 'additional_checkpoints': []}, 'logging': {'save_dir': 'output/yeast_test_run', 'tensorboard': False, 'wandb': False, 'project_name': 'yeast_test', 'run_name': 'test_run', 'use_wandb': False}, 'machine': {'output_dir': 'output', 'num_devices': 1}, 'optimizer': {'lr': 0.0001, 'min_lr': 1e-06, 'weight_decay': 0.05, 'opt': 'adamw', 'opt_eps': 1e-08, 'opt_betas': [0.9, 0.999]}, 'task': {'test_mode': 'normal', 'interpret': False, 'save_predictions': False, 'save_embeddings': False}, 'dataset': {'_target_': 'get_model.data.yeast_dataset.YeastZarrDataset', 'zarr_path': '/home/rhyswei/Code/aiyeast/get_model/input/20250601_data/yeast_data_with_conditions_original_peaks.zarr', 'split': 'train', 'batch_size': 8, 'shuffle': True, 'num_workers': 1}}
2025-06-05 15:39:02,657 - INFO - 使用设备: cpu
2025-06-05 15:39:02,679 - INFO - 数据加载完成，批次大小: 8
2025-06-05 15:39:02,683 - INFO - 模型初始化完成
2025-06-05 15:39:03,987 - INFO - 开始训练...
2025-06-05 15:39:04,411 - INFO - Epoch 1/1, Batch 0/9, Loss: 7550358.5000
2025-06-05 15:39:04,746 - INFO - Epoch 1/1, Batch 1/9, Loss: 6481876.5000
2025-06-05 15:39:05,091 - INFO - Epoch 1/1, Batch 2/9, Loss: 7964460.0000
2025-06-05 15:39:05,442 - INFO - Epoch 1/1, Batch 3/9, Loss: 7782238.5000
2025-06-05 15:39:05,769 - INFO - Epoch 1/1, Batch 4/9, Loss: 4007435.2500
2025-06-05 15:39:14,621 - INFO - Epoch 1/1, Batch 5/9, Loss: 3789673.2500
2025-06-05 15:39:05,847 - INFO - Epoch 1/1, Batch 6/9, Loss: 9187729.0000
2025-06-05 15:39:06,089 - INFO - Epoch 1/1, Batch 7/9, Loss: 4044264.0000
2025-06-05 15:39:06,143 - INFO - Epoch 1/1, Batch 8/9, Loss: 7839113.0000
2025-06-05 15:39:06,155 - INFO - Epoch 1/1, Average Loss: 6516349.7778
2025-06-05 15:39:06,163 - INFO - 保存检查点到: output/yeast_test_run/checkpoint_epoch_1.pth
2025-06-05 15:39:06,166 - INFO - 训练完成，最终模型保存到: output/yeast_test_run/final_model.pth
2025-06-05 15:41:15,588 - INFO - 开始训练，配置：
{'stage': 'fit', 'type': 'region', 'assembly': 'hg38', 'eval_tss': False, 'log_image': False, 'experiment': {'name': 'yeast_lora_finetuning', 'seed': 42, 'debug': True}, 'training': {'batch_size': 8, 'num_workers': 1, 'learning_rate': 0.0001, 'weight_decay': 0.0001, 'max_epochs': 1, 'early_stopping_patience': 2, 'gradient_clip_val': 1.0, 'use_lora': True, 'lora_rank': 2, 'lora_alpha': 8, 'lora_layers': ['encoder', 'head_exp'], 'save_every_n_epochs': 1, 'accumulate_grad_batches': 1, 'clip_grad': None, 'use_fp16': False, 'log_every_n_steps': 1, 'val_check_interval': 1.0, 'warmup_epochs': 0}, 'data': {'data_path': 'input/20250601_data/yeast_data_with_conditions_original_peaks.zarr'}, 'model': {'_target_': 'get_model.model.yeast_model.YeastModel', 'cfg': {'num_regions': 2268, 'num_motif': 283, 'embed_dim': 256, 'num_layers': 3, 'num_heads': 4, 'dropout': 0.1, 'output_dim': 1, 'flash_attn': False, 'pool_method': 'mean', 'region_embed': {'num_regions': '${model.cfg.num_regions}', 'num_features': '${model.cfg.num_motif}', 'embed_dim': '${model.cfg.embed_dim}'}, 'encoder': {'num_heads': '${model.cfg.num_heads}', 'embed_dim': '${model.cfg.embed_dim}', 'num_layers': '${model.cfg.num_layers}', 'drop_path_rate': '${model.cfg.dropout}', 'drop_rate': 0, 'attn_drop_rate': 0, 'use_mean_pooling': False, 'flash_attn': '${model.cfg.flash_attn}'}, 'head_exp': {'embed_dim': '${model.cfg.embed_dim}', 'output_dim': '${model.cfg.output_dim}', 'use_atac': False}, 'loss': {'components': {'exp': {'_target_': 'torch.nn.PoissonNLLLoss', 'reduction': 'mean', 'log_input': False}}, 'weights': {'exp': 1.0}}, 'metrics': {'components': {'exp': ['pearson', 'spearman', 'r2']}}}, 'model': {'name': 'yeast_model', 'type': 'transformer', 'feature_encoders': {'media_type': {'type': 'embedding', 'num_embeddings': 2, 'embedding_dim': 32, 'padding_idx': None}, 'temperature': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'pre_culture': {'time': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'od600': {'type': 'linear', 'in_features': 1, 'out_features': 32}}, 'drug_culture': {'time': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'drug_name': {'type': 'embedding', 'num_embeddings': 100, 'embedding_dim': 32, 'padding_idx': 0}, 'concentration': {'type': 'linear', 'in_features': 1, 'out_features': 32}}, 'carbon_source': {'type': 'embedding', 'num_embeddings': 10, 'embedding_dim': 32, 'padding_idx': 0}, 'nitrogen_source': {'type': 'embedding', 'num_embeddings': 10, 'embedding_dim': 32, 'padding_idx': 0}}, 'feature_fusion': {'type': 'concat', 'fusion_dim': 256, 'hidden_dim': 128, 'num_layers': 2, 'dropout': 0.1}, 'transformer': {'num_layers': 3, 'num_heads': 4, 'hidden_dim': 128, 'dropout': 0.1, 'activation': 'gelu', 'layer_norm_eps': 1e-05}, 'prediction_head': {'type': 'mlp', 'hidden_dims': [128, 64], 'dropout': 0.1, 'activation': 'relu', 'output_dim': 1}, 'loss': {'type': 'mse', 'reduction': 'mean'}, 'optimizer': {'type': 'adam', 'lr': 0.001, 'weight_decay': 0.0001, 'betas': [0.9, 0.999], 'eps': 1e-08}, 'scheduler': {'type': 'cosine', 'T_max': 100, 'eta_min': 1e-06}}}, 'finetune': {'pretrain_checkpoint': True, 'checkpoint': 'checkpoints/fetal_pretrain_fetal_finetune/Astrocytes/checkpoint-best.pth', 'strict': False, 'model_key': 'state_dict', 'use_lora': True, 'lora_checkpoint': None, 'rename_config': None, 'layers_with_lora': ['encoder', 'head_exp'], 'patterns_to_freeze': [], 'patterns_to_drop': [], 'additional_checkpoints': []}, 'logging': {'save_dir': 'output/yeast_test_run', 'tensorboard': False, 'wandb': False, 'project_name': 'yeast_test', 'run_name': 'test_run', 'use_wandb': False}, 'machine': {'output_dir': 'output', 'num_devices': 1}, 'optimizer': {'lr': 0.0001, 'min_lr': 1e-06, 'weight_decay': 0.05, 'opt': 'adamw', 'opt_eps': 1e-08, 'opt_betas': [0.9, 0.999]}, 'task': {'test_mode': 'normal', 'interpret': False, 'save_predictions': False, 'save_embeddings': False}, 'dataset': {'_target_': 'get_model.data.yeast_dataset.YeastZarrDataset', 'zarr_path': '/home/rhyswei/Code/aiyeast/get_model/input/20250601_data/yeast_data_with_conditions_original_peaks.zarr', 'split': 'train', 'batch_size': 8, 'shuffle': True, 'num_workers': 1}}
2025-06-05 15:41:15,588 - INFO - 使用设备: cpu
2025-06-05 15:41:15,612 - INFO - 数据加载完成，批次大小: 8
2025-06-05 15:41:45,594 - INFO - 开始训练，配置：
{'stage': 'fit', 'type': 'region', 'assembly': 'hg38', 'eval_tss': False, 'log_image': False, 'experiment': {'name': 'yeast_lora_finetuning', 'seed': 42, 'debug': True}, 'training': {'batch_size': 8, 'num_workers': 1, 'learning_rate': 0.0001, 'weight_decay': 0.0001, 'max_epochs': 1, 'early_stopping_patience': 2, 'gradient_clip_val': 1.0, 'use_lora': True, 'lora_rank': 2, 'lora_alpha': 8, 'lora_layers': ['encoder', 'head_exp'], 'save_every_n_epochs': 1, 'accumulate_grad_batches': 1, 'clip_grad': None, 'use_fp16': False, 'log_every_n_steps': 1, 'val_check_interval': 1.0, 'warmup_epochs': 0}, 'data': {'data_path': 'input/20250601_data/yeast_data_with_conditions_original_peaks.zarr'}, 'model': {'_target_': 'get_model.model.yeast_model.YeastModel', 'cfg': {'num_regions': 2268, 'num_motif': 283, 'embed_dim': 256, 'num_layers': 3, 'num_heads': 4, 'dropout': 0.1, 'output_dim': 1, 'flash_attn': False, 'pool_method': 'mean', 'region_embed': {'num_regions': '${model.cfg.num_regions}', 'num_features': '${model.cfg.num_motif}', 'embed_dim': '${model.cfg.embed_dim}'}, 'encoder': {'num_heads': '${model.cfg.num_heads}', 'embed_dim': '${model.cfg.embed_dim}', 'num_layers': '${model.cfg.num_layers}', 'drop_path_rate': '${model.cfg.dropout}', 'drop_rate': 0, 'attn_drop_rate': 0, 'use_mean_pooling': False, 'flash_attn': '${model.cfg.flash_attn}'}, 'head_exp': {'embed_dim': '${model.cfg.embed_dim}', 'output_dim': '${model.cfg.output_dim}', 'use_atac': False}, 'loss': {'components': {'exp': {'_target_': 'torch.nn.PoissonNLLLoss', 'reduction': 'mean', 'log_input': False}}, 'weights': {'exp': 1.0}}, 'metrics': {'components': {'exp': ['pearson', 'spearman', 'r2']}}}, 'model': {'name': 'yeast_model', 'type': 'transformer', 'feature_encoders': {'media_type': {'type': 'embedding', 'num_embeddings': 2, 'embedding_dim': 32, 'padding_idx': None}, 'temperature': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'pre_culture': {'time': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'od600': {'type': 'linear', 'in_features': 1, 'out_features': 32}}, 'drug_culture': {'time': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'drug_name': {'type': 'embedding', 'num_embeddings': 100, 'embedding_dim': 32, 'padding_idx': 0}, 'concentration': {'type': 'linear', 'in_features': 1, 'out_features': 32}}, 'carbon_source': {'type': 'embedding', 'num_embeddings': 10, 'embedding_dim': 32, 'padding_idx': 0}, 'nitrogen_source': {'type': 'embedding', 'num_embeddings': 10, 'embedding_dim': 32, 'padding_idx': 0}}, 'feature_fusion': {'type': 'concat', 'fusion_dim': 256, 'hidden_dim': 128, 'num_layers': 2, 'dropout': 0.1}, 'transformer': {'num_layers': 3, 'num_heads': 4, 'hidden_dim': 128, 'dropout': 0.1, 'activation': 'gelu', 'layer_norm_eps': 1e-05}, 'prediction_head': {'type': 'mlp', 'hidden_dims': [128, 64], 'dropout': 0.1, 'activation': 'relu', 'output_dim': 1}, 'loss': {'type': 'mse', 'reduction': 'mean'}, 'optimizer': {'type': 'adam', 'lr': 0.001, 'weight_decay': 0.0001, 'betas': [0.9, 0.999], 'eps': 1e-08}, 'scheduler': {'type': 'cosine', 'T_max': 100, 'eta_min': 1e-06}}}, 'finetune': {'pretrain_checkpoint': True, 'checkpoint': 'checkpoints/fetal_pretrain_fetal_finetune/Astrocytes/checkpoint-best.pth', 'strict': False, 'model_key': 'state_dict', 'use_lora': True, 'lora_checkpoint': None, 'rename_config': None, 'layers_with_lora': ['encoder', 'head_exp'], 'patterns_to_freeze': [], 'patterns_to_drop': [], 'additional_checkpoints': []}, 'logging': {'save_dir': 'output/yeast_test_run', 'tensorboard': False, 'wandb': False, 'project_name': 'yeast_test', 'run_name': 'test_run', 'use_wandb': False}, 'machine': {'output_dir': 'output', 'num_devices': 1}, 'optimizer': {'lr': 0.0001, 'min_lr': 1e-06, 'weight_decay': 0.05, 'opt': 'adamw', 'opt_eps': 1e-08, 'opt_betas': [0.9, 0.999]}, 'task': {'test_mode': 'normal', 'interpret': False, 'save_predictions': False, 'save_embeddings': False}, 'dataset': {'_target_': 'get_model.data.yeast_dataset.YeastZarrDataset', 'zarr_path': '/home/rhyswei/Code/aiyeast/get_model/input/20250601_data/yeast_data_with_conditions_original_peaks.zarr', 'split': 'train', 'batch_size': 8, 'shuffle': True, 'num_workers': 1}}
2025-06-05 15:41:45,595 - INFO - 使用设备: cpu
2025-06-05 15:41:45,616 - INFO - 数据加载完成，批次大小: 8
2025-06-05 15:42:10,937 - INFO - 开始训练，配置：
{'stage': 'fit', 'type': 'region', 'assembly': 'hg38', 'eval_tss': False, 'log_image': False, 'experiment': {'name': 'yeast_lora_finetuning', 'seed': 42, 'debug': True}, 'training': {'batch_size': 8, 'num_workers': 1, 'learning_rate': 0.0001, 'weight_decay': 0.0001, 'max_epochs': 1, 'early_stopping_patience': 2, 'gradient_clip_val': 1.0, 'use_lora': True, 'lora_rank': 2, 'lora_alpha': 8, 'lora_layers': ['encoder', 'head_exp'], 'save_every_n_epochs': 1, 'accumulate_grad_batches': 1, 'clip_grad': None, 'use_fp16': False, 'log_every_n_steps': 1, 'val_check_interval': 1.0, 'warmup_epochs': 0}, 'data': {'data_path': 'input/20250601_data/yeast_data_with_conditions_original_peaks.zarr'}, 'model': {'_target_': 'get_model.model.yeast_model.YeastModel', 'cfg': {'num_regions': 2268, 'num_motif': 283, 'embed_dim': 256, 'num_layers': 3, 'num_heads': 4, 'dropout': 0.1, 'output_dim': 1, 'flash_attn': False, 'pool_method': 'mean', 'region_embed': {'num_regions': '${model.cfg.num_regions}', 'num_features': '${model.cfg.num_motif}', 'embed_dim': '${model.cfg.embed_dim}'}, 'encoder': {'num_heads': '${model.cfg.num_heads}', 'embed_dim': '${model.cfg.embed_dim}', 'num_layers': '${model.cfg.num_layers}', 'drop_path_rate': '${model.cfg.dropout}', 'drop_rate': 0, 'attn_drop_rate': 0, 'use_mean_pooling': False, 'flash_attn': '${model.cfg.flash_attn}'}, 'head_exp': {'embed_dim': '${model.cfg.embed_dim}', 'output_dim': '${model.cfg.output_dim}', 'use_atac': False}, 'loss': {'components': {'exp': {'_target_': 'torch.nn.PoissonNLLLoss', 'reduction': 'mean', 'log_input': False}}, 'weights': {'exp': 1.0}}, 'metrics': {'components': {'exp': ['pearson', 'spearman', 'r2']}}}, 'model': {'name': 'yeast_model', 'type': 'transformer', 'feature_encoders': {'media_type': {'type': 'embedding', 'num_embeddings': 2, 'embedding_dim': 32, 'padding_idx': None}, 'temperature': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'pre_culture': {'time': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'od600': {'type': 'linear', 'in_features': 1, 'out_features': 32}}, 'drug_culture': {'time': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'drug_name': {'type': 'embedding', 'num_embeddings': 100, 'embedding_dim': 32, 'padding_idx': 0}, 'concentration': {'type': 'linear', 'in_features': 1, 'out_features': 32}}, 'carbon_source': {'type': 'embedding', 'num_embeddings': 10, 'embedding_dim': 32, 'padding_idx': 0}, 'nitrogen_source': {'type': 'embedding', 'num_embeddings': 10, 'embedding_dim': 32, 'padding_idx': 0}}, 'feature_fusion': {'type': 'concat', 'fusion_dim': 256, 'hidden_dim': 128, 'num_layers': 2, 'dropout': 0.1}, 'transformer': {'num_layers': 3, 'num_heads': 4, 'hidden_dim': 128, 'dropout': 0.1, 'activation': 'gelu', 'layer_norm_eps': 1e-05}, 'prediction_head': {'type': 'mlp', 'hidden_dims': [128, 64], 'dropout': 0.1, 'activation': 'relu', 'output_dim': 1}, 'loss': {'type': 'mse', 'reduction': 'mean'}, 'optimizer': {'type': 'adam', 'lr': 0.001, 'weight_decay': 0.0001, 'betas': [0.9, 0.999], 'eps': 1e-08}, 'scheduler': {'type': 'cosine', 'T_max': 100, 'eta_min': 1e-06}}}, 'finetune': {'pretrain_checkpoint': True, 'checkpoint': 'checkpoints/fetal_pretrain_fetal_finetune/Astrocytes/checkpoint-best.pth', 'strict': False, 'model_key': 'state_dict', 'use_lora': True, 'lora_checkpoint': None, 'rename_config': None, 'layers_with_lora': ['encoder', 'head_exp'], 'patterns_to_freeze': [], 'patterns_to_drop': [], 'additional_checkpoints': []}, 'logging': {'save_dir': 'output/yeast_test_run', 'tensorboard': False, 'wandb': False, 'project_name': 'yeast_test', 'run_name': 'test_run', 'use_wandb': False}, 'machine': {'output_dir': 'output', 'num_devices': 1}, 'optimizer': {'lr': 0.0001, 'min_lr': 1e-06, 'weight_decay': 0.05, 'opt': 'adamw', 'opt_eps': 1e-08, 'opt_betas': [0.9, 0.999]}, 'task': {'test_mode': 'normal', 'interpret': False, 'save_predictions': False, 'save_embeddings': False}, 'dataset': {'_target_': 'get_model.data.yeast_dataset.YeastZarrDataset', 'zarr_path': '/home/rhyswei/Code/aiyeast/get_model/input/20250601_data/yeast_data_with_conditions_original_peaks.zarr', 'split': 'train', 'batch_size': 8, 'shuffle': True, 'num_workers': 1}}
2025-06-05 15:42:10,937 - INFO - 使用设备: cpu
2025-06-05 15:42:10,962 - INFO - 数据加载完成，批次大小: 8
2025-06-05 15:42:10,986 - INFO - 模型初始化完成
2025-06-05 15:42:11,575 - INFO - 开始训练...
2025-06-05 15:46:19,666 - INFO - 开始训练，配置：
{'stage': 'fit', 'type': 'region', 'assembly': 'hg38', 'eval_tss': False, 'log_image': False, 'experiment': {'name': 'yeast_lora_finetuning', 'seed': 42, 'debug': True}, 'training': {'batch_size': 8, 'num_workers': 1, 'learning_rate': 0.0001, 'weight_decay': 0.0001, 'max_epochs': 1, 'early_stopping_patience': 2, 'gradient_clip_val': 1.0, 'use_lora': True, 'lora_rank': 2, 'lora_alpha': 8, 'lora_layers': ['encoder', 'head_exp'], 'save_every_n_epochs': 1, 'accumulate_grad_batches': 1, 'clip_grad': None, 'use_fp16': False, 'log_every_n_steps': 1, 'val_check_interval': 1.0, 'warmup_epochs': 0}, 'data': {'data_path': 'input/20250601_data/yeast_data_with_conditions_original_peaks.zarr'}, 'model': {'_target_': 'get_model.model.yeast_model.YeastModel', 'cfg': {'num_regions': 2268, 'num_motif': 283, 'embed_dim': 256, 'num_layers': 3, 'num_heads': 4, 'dropout': 0.1, 'output_dim': 1, 'flash_attn': False, 'pool_method': 'mean', 'region_embed': {'num_regions': '${model.cfg.num_regions}', 'num_features': '${model.cfg.num_motif}', 'embed_dim': '${model.cfg.embed_dim}'}, 'encoder': {'num_heads': '${model.cfg.num_heads}', 'embed_dim': '${model.cfg.embed_dim}', 'num_layers': '${model.cfg.num_layers}', 'drop_path_rate': '${model.cfg.dropout}', 'drop_rate': 0, 'attn_drop_rate': 0, 'use_mean_pooling': False, 'flash_attn': '${model.cfg.flash_attn}'}, 'head_exp': {'embed_dim': '${model.cfg.embed_dim}', 'output_dim': '${model.cfg.output_dim}', 'use_atac': False}, 'loss': {'components': {'exp': {'_target_': 'torch.nn.PoissonNLLLoss', 'reduction': 'mean', 'log_input': False}}, 'weights': {'exp': 1.0}}, 'metrics': {'components': {'exp': ['pearson', 'spearman', 'r2']}}}, 'model': {'name': 'yeast_model', 'type': 'transformer', 'feature_encoders': {'media_type': {'type': 'embedding', 'num_embeddings': 2, 'embedding_dim': 32, 'padding_idx': None}, 'temperature': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'pre_culture': {'time': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'od600': {'type': 'linear', 'in_features': 1, 'out_features': 32}}, 'drug_culture': {'time': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'drug_name': {'type': 'embedding', 'num_embeddings': 100, 'embedding_dim': 32, 'padding_idx': 0}, 'concentration': {'type': 'linear', 'in_features': 1, 'out_features': 32}}, 'carbon_source': {'type': 'embedding', 'num_embeddings': 10, 'embedding_dim': 32, 'padding_idx': 0}, 'nitrogen_source': {'type': 'embedding', 'num_embeddings': 10, 'embedding_dim': 32, 'padding_idx': 0}}, 'feature_fusion': {'type': 'concat', 'fusion_dim': 256, 'hidden_dim': 128, 'num_layers': 2, 'dropout': 0.1}, 'transformer': {'num_layers': 3, 'num_heads': 4, 'hidden_dim': 128, 'dropout': 0.1, 'activation': 'gelu', 'layer_norm_eps': 1e-05}, 'prediction_head': {'type': 'mlp', 'hidden_dims': [128, 64], 'dropout': 0.1, 'activation': 'relu', 'output_dim': 1}, 'loss': {'type': 'mse', 'reduction': 'mean'}, 'optimizer': {'type': 'adam', 'lr': 0.001, 'weight_decay': 0.0001, 'betas': [0.9, 0.999], 'eps': 1e-08}, 'scheduler': {'type': 'cosine', 'T_max': 100, 'eta_min': 1e-06}}}, 'finetune': {'pretrain_checkpoint': True, 'checkpoint': 'checkpoints/fetal_pretrain_fetal_finetune/Astrocytes/checkpoint-best.pth', 'strict': False, 'model_key': 'state_dict', 'use_lora': True, 'lora_checkpoint': None, 'rename_config': None, 'layers_with_lora': ['encoder', 'head_exp'], 'patterns_to_freeze': [], 'patterns_to_drop': [], 'additional_checkpoints': []}, 'logging': {'save_dir': 'output/yeast_test_run', 'tensorboard': False, 'wandb': False, 'project_name': 'yeast_test', 'run_name': 'test_run', 'use_wandb': False}, 'machine': {'output_dir': 'output', 'num_devices': 1}, 'optimizer': {'lr': 0.0001, 'min_lr': 1e-06, 'weight_decay': 0.05, 'opt': 'adamw', 'opt_eps': 1e-08, 'opt_betas': [0.9, 0.999]}, 'task': {'test_mode': 'normal', 'interpret': False, 'save_predictions': False, 'save_embeddings': False}, 'dataset': {'_target_': 'get_model.data.yeast_dataset.YeastZarrDataset', 'zarr_path': '/home/rhyswei/Code/aiyeast/get_model/input/20250601_data/yeast_data_with_conditions_original_peaks.zarr', 'split': 'train', 'batch_size': 8, 'shuffle': True, 'num_workers': 1}}
2025-06-05 15:46:19,667 - INFO - 使用设备: cpu
2025-06-05 15:46:19,687 - INFO - 数据加载完成，批次大小: 8
2025-06-05 15:46:19,725 - INFO - 模型初始化完成
2025-06-05 15:46:20,881 - INFO - 开始训练...
2025-06-05 15:49:50,513 - INFO - 开始训练，配置：
{'stage': 'fit', 'type': 'region', 'assembly': 'hg38', 'eval_tss': False, 'log_image': False, 'experiment': {'name': 'yeast_lora_finetuning', 'seed': 42, 'debug': True}, 'training': {'batch_size': 8, 'num_workers': 1, 'learning_rate': 0.0001, 'weight_decay': 0.0001, 'max_epochs': 1, 'early_stopping_patience': 2, 'gradient_clip_val': 1.0, 'use_lora': True, 'lora_rank': 2, 'lora_alpha': 8, 'lora_layers': ['encoder', 'head_exp'], 'save_every_n_epochs': 1, 'accumulate_grad_batches': 1, 'clip_grad': None, 'use_fp16': False, 'log_every_n_steps': 1, 'val_check_interval': 1.0, 'warmup_epochs': 0}, 'data': {'data_path': 'input/20250601_data/yeast_data_with_conditions_original_peaks.zarr'}, 'model': {'_target_': 'get_model.model.yeast_model.YeastModel', 'cfg': {'num_regions': 2268, 'num_motif': 283, 'embed_dim': 256, 'num_layers': 3, 'num_heads': 4, 'dropout': 0.1, 'output_dim': 1, 'flash_attn': False, 'pool_method': 'mean', 'region_embed': {'num_regions': '${model.cfg.num_regions}', 'num_features': '${model.cfg.num_motif}', 'embed_dim': '${model.cfg.embed_dim}'}, 'encoder': {'num_heads': '${model.cfg.num_heads}', 'embed_dim': '${model.cfg.embed_dim}', 'num_layers': '${model.cfg.num_layers}', 'drop_path_rate': '${model.cfg.dropout}', 'drop_rate': 0, 'attn_drop_rate': 0, 'use_mean_pooling': False, 'flash_attn': '${model.cfg.flash_attn}'}, 'head_exp': {'embed_dim': '${model.cfg.embed_dim}', 'output_dim': '${model.cfg.output_dim}', 'use_atac': False}, 'loss': {'components': {'exp': {'_target_': 'torch.nn.PoissonNLLLoss', 'reduction': 'mean', 'log_input': False}}, 'weights': {'exp': 1.0}}, 'metrics': {'components': {'exp': ['pearson', 'spearman', 'r2']}}}, 'model': {'name': 'yeast_model', 'type': 'transformer', 'feature_encoders': {'media_type': {'type': 'embedding', 'num_embeddings': 2, 'embedding_dim': 32, 'padding_idx': None}, 'temperature': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'pre_culture': {'time': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'od600': {'type': 'linear', 'in_features': 1, 'out_features': 32}}, 'drug_culture': {'time': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'drug_name': {'type': 'embedding', 'num_embeddings': 100, 'embedding_dim': 32, 'padding_idx': 0}, 'concentration': {'type': 'linear', 'in_features': 1, 'out_features': 32}}, 'carbon_source': {'type': 'embedding', 'num_embeddings': 10, 'embedding_dim': 32, 'padding_idx': 0}, 'nitrogen_source': {'type': 'embedding', 'num_embeddings': 10, 'embedding_dim': 32, 'padding_idx': 0}}, 'feature_fusion': {'type': 'concat', 'fusion_dim': 256, 'hidden_dim': 128, 'num_layers': 2, 'dropout': 0.1}, 'transformer': {'num_layers': 3, 'num_heads': 4, 'hidden_dim': 128, 'dropout': 0.1, 'activation': 'gelu', 'layer_norm_eps': 1e-05}, 'prediction_head': {'type': 'mlp', 'hidden_dims': [128, 64], 'dropout': 0.1, 'activation': 'relu', 'output_dim': 1}, 'loss': {'type': 'mse', 'reduction': 'mean'}, 'optimizer': {'type': 'adam', 'lr': 0.001, 'weight_decay': 0.0001, 'betas': [0.9, 0.999], 'eps': 1e-08}, 'scheduler': {'type': 'cosine', 'T_max': 100, 'eta_min': 1e-06}}}, 'finetune': {'pretrain_checkpoint': True, 'checkpoint': 'checkpoints/fetal_pretrain_fetal_finetune/Astrocytes/checkpoint-best.pth', 'strict': False, 'model_key': 'state_dict', 'use_lora': True, 'lora_checkpoint': None, 'rename_config': None, 'layers_with_lora': ['encoder', 'head_exp'], 'patterns_to_freeze': [], 'patterns_to_drop': [], 'additional_checkpoints': []}, 'logging': {'save_dir': 'output/yeast_test_run', 'tensorboard': False, 'wandb': False, 'project_name': 'yeast_test', 'run_name': 'test_run', 'use_wandb': False}, 'machine': {'output_dir': 'output', 'num_devices': 1}, 'optimizer': {'lr': 0.0001, 'min_lr': 1e-06, 'weight_decay': 0.05, 'opt': 'adamw', 'opt_eps': 1e-08, 'opt_betas': [0.9, 0.999]}, 'task': {'test_mode': 'normal', 'interpret': False, 'save_predictions': False, 'save_embeddings': False}, 'dataset': {'_target_': 'get_model.data.yeast_dataset.YeastZarrDataset', 'zarr_path': '/home/rhyswei/Code/aiyeast/get_model/input/20250601_data/yeast_data_with_conditions_original_peaks.zarr', 'split': 'train', 'batch_size': 8, 'shuffle': True, 'num_workers': 1}}
2025-06-05 15:49:50,516 - INFO - 使用设备: cpu
2025-06-05 15:49:50,574 - INFO - 数据加载完成，批次大小: 8
2025-06-05 15:49:50,670 - INFO - 模型初始化完成
2025-06-05 15:49:52,953 - INFO - 开始训练...
2025-06-05 15:50:32,912 - INFO - 开始训练，配置：
{'stage': 'fit', 'type': 'region', 'assembly': 'hg38', 'eval_tss': False, 'log_image': False, 'experiment': {'name': 'yeast_lora_finetuning', 'seed': 42, 'debug': True}, 'training': {'batch_size': 8, 'num_workers': 1, 'learning_rate': 0.0001, 'weight_decay': 0.0001, 'max_epochs': 1, 'early_stopping_patience': 2, 'gradient_clip_val': 1.0, 'use_lora': True, 'lora_rank': 2, 'lora_alpha': 8, 'lora_layers': ['encoder', 'head_exp'], 'save_every_n_epochs': 1, 'accumulate_grad_batches': 1, 'clip_grad': None, 'use_fp16': False, 'log_every_n_steps': 1, 'val_check_interval': 1.0, 'warmup_epochs': 0}, 'data': {'data_path': 'input/20250601_data/yeast_data_with_conditions_original_peaks.zarr'}, 'model': {'_target_': 'get_model.model.yeast_model.YeastModel', 'cfg': {'num_regions': 2268, 'num_motif': 283, 'embed_dim': 256, 'num_layers': 3, 'num_heads': 4, 'dropout': 0.1, 'output_dim': 1, 'flash_attn': False, 'pool_method': 'mean', 'region_embed': {'num_regions': '${model.cfg.num_regions}', 'num_features': '${model.cfg.num_motif}', 'embed_dim': '${model.cfg.embed_dim}'}, 'encoder': {'num_heads': '${model.cfg.num_heads}', 'embed_dim': '${model.cfg.embed_dim}', 'num_layers': '${model.cfg.num_layers}', 'drop_path_rate': '${model.cfg.dropout}', 'drop_rate': 0, 'attn_drop_rate': 0, 'use_mean_pooling': False, 'flash_attn': '${model.cfg.flash_attn}'}, 'head_exp': {'embed_dim': '${model.cfg.embed_dim}', 'output_dim': '${model.cfg.output_dim}', 'use_atac': False}, 'loss': {'components': {'exp': {'_target_': 'torch.nn.PoissonNLLLoss', 'reduction': 'mean', 'log_input': False}}, 'weights': {'exp': 1.0}}, 'metrics': {'components': {'exp': ['pearson', 'spearman', 'r2']}}}, 'model': {'name': 'yeast_model', 'type': 'transformer', 'feature_encoders': {'media_type': {'type': 'embedding', 'num_embeddings': 2, 'embedding_dim': 32, 'padding_idx': None}, 'temperature': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'pre_culture': {'time': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'od600': {'type': 'linear', 'in_features': 1, 'out_features': 32}}, 'drug_culture': {'time': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'drug_name': {'type': 'embedding', 'num_embeddings': 100, 'embedding_dim': 32, 'padding_idx': 0}, 'concentration': {'type': 'linear', 'in_features': 1, 'out_features': 32}}, 'carbon_source': {'type': 'embedding', 'num_embeddings': 10, 'embedding_dim': 32, 'padding_idx': 0}, 'nitrogen_source': {'type': 'embedding', 'num_embeddings': 10, 'embedding_dim': 32, 'padding_idx': 0}}, 'feature_fusion': {'type': 'concat', 'fusion_dim': 256, 'hidden_dim': 128, 'num_layers': 2, 'dropout': 0.1}, 'transformer': {'num_layers': 3, 'num_heads': 4, 'hidden_dim': 128, 'dropout': 0.1, 'activation': 'gelu', 'layer_norm_eps': 1e-05}, 'prediction_head': {'type': 'mlp', 'hidden_dims': [128, 64], 'dropout': 0.1, 'activation': 'relu', 'output_dim': 1}, 'loss': {'type': 'mse', 'reduction': 'mean'}, 'optimizer': {'type': 'adam', 'lr': 0.001, 'weight_decay': 0.0001, 'betas': [0.9, 0.999], 'eps': 1e-08}, 'scheduler': {'type': 'cosine', 'T_max': 100, 'eta_min': 1e-06}}}, 'finetune': {'pretrain_checkpoint': True, 'checkpoint': 'checkpoints/fetal_pretrain_fetal_finetune/Astrocytes/checkpoint-best.pth', 'strict': False, 'model_key': 'state_dict', 'use_lora': True, 'lora_checkpoint': None, 'rename_config': None, 'layers_with_lora': ['encoder', 'head_exp'], 'patterns_to_freeze': [], 'patterns_to_drop': [], 'additional_checkpoints': []}, 'logging': {'save_dir': 'output/yeast_test_run', 'tensorboard': False, 'wandb': False, 'project_name': 'yeast_test', 'run_name': 'test_run', 'use_wandb': False}, 'machine': {'output_dir': 'output', 'num_devices': 1}, 'optimizer': {'lr': 0.0001, 'min_lr': 1e-06, 'weight_decay': 0.05, 'opt': 'adamw', 'opt_eps': 1e-08, 'opt_betas': [0.9, 0.999]}, 'task': {'test_mode': 'normal', 'interpret': False, 'save_predictions': False, 'save_embeddings': False}, 'dataset': {'_target_': 'get_model.data.yeast_dataset.YeastZarrDataset', 'zarr_path': '/home/rhyswei/Code/aiyeast/get_model/input/20250601_data/yeast_data_with_conditions_original_peaks.zarr', 'split': 'train', 'batch_size': 8, 'shuffle': True, 'num_workers': 1}}
2025-06-05 15:50:32,913 - INFO - 使用设备: cpu
2025-06-05 15:50:32,938 - INFO - 数据加载完成，批次大小: 8
2025-06-05 15:50:32,969 - INFO - 模型初始化完成
2025-06-05 15:50:34,324 - INFO - 开始训练...
2025-06-05 15:51:19,745 - INFO - 开始训练，配置：
{'stage': 'fit', 'type': 'region', 'assembly': 'hg38', 'eval_tss': False, 'log_image': False, 'experiment': {'name': 'yeast_lora_finetuning', 'seed': 42, 'debug': True}, 'training': {'batch_size': 8, 'num_workers': 1, 'learning_rate': 0.0001, 'weight_decay': 0.0001, 'max_epochs': 1, 'early_stopping_patience': 2, 'gradient_clip_val': 1.0, 'use_lora': True, 'lora_rank': 2, 'lora_alpha': 8, 'lora_layers': ['encoder', 'head_exp'], 'save_every_n_epochs': 1, 'accumulate_grad_batches': 1, 'clip_grad': None, 'use_fp16': False, 'log_every_n_steps': 1, 'val_check_interval': 1.0, 'warmup_epochs': 0}, 'data': {'data_path': 'input/20250601_data/yeast_data_with_conditions_original_peaks.zarr'}, 'model': {'_target_': 'get_model.model.yeast_model.YeastModel', 'cfg': {'num_regions': 2268, 'num_motif': 283, 'embed_dim': 256, 'num_layers': 3, 'num_heads': 4, 'dropout': 0.1, 'output_dim': 1, 'flash_attn': False, 'pool_method': 'mean', 'region_embed': {'num_regions': '${model.cfg.num_regions}', 'num_features': '${model.cfg.num_motif}', 'embed_dim': '${model.cfg.embed_dim}'}, 'encoder': {'num_heads': '${model.cfg.num_heads}', 'embed_dim': '${model.cfg.embed_dim}', 'num_layers': '${model.cfg.num_layers}', 'drop_path_rate': '${model.cfg.dropout}', 'drop_rate': 0, 'attn_drop_rate': 0, 'use_mean_pooling': False, 'flash_attn': '${model.cfg.flash_attn}'}, 'head_exp': {'embed_dim': '${model.cfg.embed_dim}', 'output_dim': '${model.cfg.output_dim}', 'use_atac': False}, 'loss': {'components': {'exp': {'_target_': 'torch.nn.PoissonNLLLoss', 'reduction': 'mean', 'log_input': False}}, 'weights': {'exp': 1.0}}, 'metrics': {'components': {'exp': ['pearson', 'spearman', 'r2']}}}, 'model': {'name': 'yeast_model', 'type': 'transformer', 'feature_encoders': {'media_type': {'type': 'embedding', 'num_embeddings': 2, 'embedding_dim': 32, 'padding_idx': None}, 'temperature': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'pre_culture': {'time': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'od600': {'type': 'linear', 'in_features': 1, 'out_features': 32}}, 'drug_culture': {'time': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'drug_name': {'type': 'embedding', 'num_embeddings': 100, 'embedding_dim': 32, 'padding_idx': 0}, 'concentration': {'type': 'linear', 'in_features': 1, 'out_features': 32}}, 'carbon_source': {'type': 'embedding', 'num_embeddings': 10, 'embedding_dim': 32, 'padding_idx': 0}, 'nitrogen_source': {'type': 'embedding', 'num_embeddings': 10, 'embedding_dim': 32, 'padding_idx': 0}}, 'feature_fusion': {'type': 'concat', 'fusion_dim': 256, 'hidden_dim': 128, 'num_layers': 2, 'dropout': 0.1}, 'transformer': {'num_layers': 3, 'num_heads': 4, 'hidden_dim': 128, 'dropout': 0.1, 'activation': 'gelu', 'layer_norm_eps': 1e-05}, 'prediction_head': {'type': 'mlp', 'hidden_dims': [128, 64], 'dropout': 0.1, 'activation': 'relu', 'output_dim': 1}, 'loss': {'type': 'mse', 'reduction': 'mean'}, 'optimizer': {'type': 'adam', 'lr': 0.001, 'weight_decay': 0.0001, 'betas': [0.9, 0.999], 'eps': 1e-08}, 'scheduler': {'type': 'cosine', 'T_max': 100, 'eta_min': 1e-06}}}, 'finetune': {'pretrain_checkpoint': True, 'checkpoint': 'checkpoints/fetal_pretrain_fetal_finetune/Astrocytes/checkpoint-best.pth', 'strict': False, 'model_key': 'state_dict', 'use_lora': True, 'lora_checkpoint': None, 'rename_config': None, 'layers_with_lora': ['encoder', 'head_exp'], 'patterns_to_freeze': [], 'patterns_to_drop': [], 'additional_checkpoints': []}, 'logging': {'save_dir': 'output/yeast_test_run', 'tensorboard': False, 'wandb': False, 'project_name': 'yeast_test', 'run_name': 'test_run', 'use_wandb': False}, 'machine': {'output_dir': 'output', 'num_devices': 1}, 'optimizer': {'lr': 0.0001, 'min_lr': 1e-06, 'weight_decay': 0.05, 'opt': 'adamw', 'opt_eps': 1e-08, 'opt_betas': [0.9, 0.999]}, 'task': {'test_mode': 'normal', 'interpret': False, 'save_predictions': False, 'save_embeddings': False}, 'dataset': {'_target_': 'get_model.data.yeast_dataset.YeastZarrDataset', 'zarr_path': '/home/rhyswei/Code/aiyeast/get_model/input/20250601_data/yeast_data_with_conditions_original_peaks.zarr', 'split': 'train', 'batch_size': 8, 'shuffle': True, 'num_workers': 1}}
2025-06-05 15:51:19,745 - INFO - 使用设备: cpu
2025-06-05 15:51:19,767 - INFO - 数据加载完成，批次大小: 8
2025-06-05 15:51:19,800 - INFO - 模型初始化完成
2025-06-05 15:51:21,105 - INFO - 开始训练...
2025-06-05 15:51:55,953 - INFO - 开始训练，配置：
{'stage': 'fit', 'type': 'region', 'assembly': 'hg38', 'eval_tss': False, 'log_image': False, 'experiment': {'name': 'yeast_lora_finetuning', 'seed': 42, 'debug': True}, 'training': {'batch_size': 8, 'num_workers': 1, 'learning_rate': 0.0001, 'weight_decay': 0.0001, 'max_epochs': 1, 'early_stopping_patience': 2, 'gradient_clip_val': 1.0, 'use_lora': True, 'lora_rank': 2, 'lora_alpha': 8, 'lora_layers': ['encoder', 'head_exp'], 'save_every_n_epochs': 1, 'accumulate_grad_batches': 1, 'clip_grad': None, 'use_fp16': False, 'log_every_n_steps': 1, 'val_check_interval': 1.0, 'warmup_epochs': 0}, 'data': {'data_path': 'input/20250601_data/yeast_data_with_conditions_original_peaks.zarr'}, 'model': {'_target_': 'get_model.model.yeast_model.YeastModel', 'cfg': {'num_regions': 2268, 'num_motif': 283, 'embed_dim': 256, 'num_layers': 3, 'num_heads': 4, 'dropout': 0.1, 'output_dim': 1, 'flash_attn': False, 'pool_method': 'mean', 'region_embed': {'num_regions': '${model.cfg.num_regions}', 'num_features': '${model.cfg.num_motif}', 'embed_dim': '${model.cfg.embed_dim}'}, 'encoder': {'num_heads': '${model.cfg.num_heads}', 'embed_dim': '${model.cfg.embed_dim}', 'num_layers': '${model.cfg.num_layers}', 'drop_path_rate': '${model.cfg.dropout}', 'drop_rate': 0, 'attn_drop_rate': 0, 'use_mean_pooling': False, 'flash_attn': '${model.cfg.flash_attn}'}, 'head_exp': {'embed_dim': '${model.cfg.embed_dim}', 'output_dim': '${model.cfg.output_dim}', 'use_atac': False}, 'loss': {'components': {'exp': {'_target_': 'torch.nn.PoissonNLLLoss', 'reduction': 'mean', 'log_input': False}}, 'weights': {'exp': 1.0}}, 'metrics': {'components': {'exp': ['pearson', 'spearman', 'r2']}}}, 'model': {'name': 'yeast_model', 'type': 'transformer', 'feature_encoders': {'media_type': {'type': 'embedding', 'num_embeddings': 2, 'embedding_dim': 32, 'padding_idx': None}, 'temperature': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'pre_culture': {'time': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'od600': {'type': 'linear', 'in_features': 1, 'out_features': 32}}, 'drug_culture': {'time': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'drug_name': {'type': 'embedding', 'num_embeddings': 100, 'embedding_dim': 32, 'padding_idx': 0}, 'concentration': {'type': 'linear', 'in_features': 1, 'out_features': 32}}, 'carbon_source': {'type': 'embedding', 'num_embeddings': 10, 'embedding_dim': 32, 'padding_idx': 0}, 'nitrogen_source': {'type': 'embedding', 'num_embeddings': 10, 'embedding_dim': 32, 'padding_idx': 0}}, 'feature_fusion': {'type': 'concat', 'fusion_dim': 256, 'hidden_dim': 128, 'num_layers': 2, 'dropout': 0.1}, 'transformer': {'num_layers': 3, 'num_heads': 4, 'hidden_dim': 128, 'dropout': 0.1, 'activation': 'gelu', 'layer_norm_eps': 1e-05}, 'prediction_head': {'type': 'mlp', 'hidden_dims': [128, 64], 'dropout': 0.1, 'activation': 'relu', 'output_dim': 1}, 'loss': {'type': 'mse', 'reduction': 'mean'}, 'optimizer': {'type': 'adam', 'lr': 0.001, 'weight_decay': 0.0001, 'betas': [0.9, 0.999], 'eps': 1e-08}, 'scheduler': {'type': 'cosine', 'T_max': 100, 'eta_min': 1e-06}}}, 'finetune': {'pretrain_checkpoint': True, 'checkpoint': 'checkpoints/fetal_pretrain_fetal_finetune/Astrocytes/checkpoint-best.pth', 'strict': False, 'model_key': 'state_dict', 'use_lora': True, 'lora_checkpoint': None, 'rename_config': None, 'layers_with_lora': ['encoder', 'head_exp'], 'patterns_to_freeze': [], 'patterns_to_drop': [], 'additional_checkpoints': []}, 'logging': {'save_dir': 'output/yeast_test_run', 'tensorboard': False, 'wandb': False, 'project_name': 'yeast_test', 'run_name': 'test_run', 'use_wandb': False}, 'machine': {'output_dir': 'output', 'num_devices': 1}, 'optimizer': {'lr': 0.0001, 'min_lr': 1e-06, 'weight_decay': 0.05, 'opt': 'adamw', 'opt_eps': 1e-08, 'opt_betas': [0.9, 0.999]}, 'task': {'test_mode': 'normal', 'interpret': False, 'save_predictions': False, 'save_embeddings': False}, 'dataset': {'_target_': 'get_model.data.yeast_dataset.YeastZarrDataset', 'zarr_path': '/home/rhyswei/Code/aiyeast/get_model/input/20250601_data/yeast_data_with_conditions_original_peaks.zarr', 'split': 'train', 'batch_size': 8, 'shuffle': True, 'num_workers': 1}}
2025-06-05 15:51:55,954 - INFO - 使用设备: cpu
2025-06-05 15:51:55,980 - INFO - 数据加载完成，批次大小: 8
2025-06-05 15:51:56,006 - INFO - 模型初始化完成
2025-06-05 15:52:05,815 - INFO - 开始训练...
2025-06-05 15:52:07,524 - INFO - Epoch 1/1, Batch 0/9, Loss: 4211463.0000
2025-06-05 15:52:19,143 - INFO - Epoch 1/1, Batch 1/9, Loss: 4907904.0000
2025-06-05 15:52:28,846 - INFO - Epoch 1/1, Batch 2/9, Loss: 6738886.5000
2025-06-05 15:52:38,710 - INFO - Epoch 1/1, Batch 3/9, Loss: 9776500.0000
2025-06-05 15:52:47,800 - INFO - Epoch 1/1, Batch 4/9, Loss: 5679837.0000
2025-06-05 15:53:06,043 - INFO - Epoch 1/1, Batch 5/9, Loss: 4748384.0000
2025-06-05 15:53:06,633 - INFO - Epoch 1/1, Batch 6/9, Loss: 10878515.0000
2025-06-05 15:53:16,984 - INFO - Epoch 1/1, Batch 7/9, Loss: 3084353.5000
2025-06-05 15:53:19,314 - INFO - Epoch 1/1, Batch 8/9, Loss: 10948566.0000
2025-06-05 15:53:19,337 - INFO - Epoch 1/1, Average Loss: 6774934.3333
2025-06-05 15:53:19,360 - INFO - Model saved to output/yeast_test_run/model_epoch_1.pth
2025-06-05 15:53:19,375 - INFO - Final model saved to output/yeast_test_run/final_model.pth
2025-06-05 15:54:26,376 - INFO - 开始训练，配置：
{'stage': 'fit', 'type': 'region', 'assembly': 'hg38', 'eval_tss': False, 'log_image': False, 'experiment': {'name': 'yeast_lora_finetuning', 'seed': 42, 'debug': True}, 'training': {'batch_size': 8, 'num_workers': 1, 'learning_rate': 0.0001, 'weight_decay': 0.0001, 'max_epochs': 1, 'early_stopping_patience': 2, 'gradient_clip_val': 1.0, 'use_lora': True, 'lora_rank': 2, 'lora_alpha': 8, 'lora_layers': ['encoder', 'head_exp'], 'save_every_n_epochs': 1, 'accumulate_grad_batches': 1, 'clip_grad': None, 'use_fp16': False, 'log_every_n_steps': 1, 'val_check_interval': 1.0, 'warmup_epochs': 0}, 'data': {'data_path': 'input/20250601_data/yeast_data_with_conditions_original_peaks.zarr'}, 'model': {'_target_': 'get_model.model.yeast_model.YeastModel', 'cfg': {'num_regions': 2268, 'num_motif': 283, 'embed_dim': 256, 'num_layers': 3, 'num_heads': 4, 'dropout': 0.1, 'output_dim': 1, 'flash_attn': False, 'pool_method': 'mean', 'region_embed': {'num_regions': '${model.cfg.num_regions}', 'num_features': '${model.cfg.num_motif}', 'embed_dim': '${model.cfg.embed_dim}'}, 'encoder': {'num_heads': '${model.cfg.num_heads}', 'embed_dim': '${model.cfg.embed_dim}', 'num_layers': '${model.cfg.num_layers}', 'drop_path_rate': '${model.cfg.dropout}', 'drop_rate': 0, 'attn_drop_rate': 0, 'use_mean_pooling': False, 'flash_attn': '${model.cfg.flash_attn}'}, 'head_exp': {'embed_dim': '${model.cfg.embed_dim}', 'output_dim': '${model.cfg.output_dim}', 'use_atac': False}, 'loss': {'components': {'exp': {'_target_': 'torch.nn.PoissonNLLLoss', 'reduction': 'mean', 'log_input': False}}, 'weights': {'exp': 1.0}}, 'metrics': {'components': {'exp': ['pearson', 'spearman', 'r2']}}}, 'model': {'name': 'yeast_model', 'type': 'transformer', 'feature_encoders': {'media_type': {'type': 'embedding', 'num_embeddings': 2, 'embedding_dim': 32, 'padding_idx': None}, 'temperature': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'pre_culture': {'time': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'od600': {'type': 'linear', 'in_features': 1, 'out_features': 32}}, 'drug_culture': {'time': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'drug_name': {'type': 'embedding', 'num_embeddings': 100, 'embedding_dim': 32, 'padding_idx': 0}, 'concentration': {'type': 'linear', 'in_features': 1, 'out_features': 32}}, 'carbon_source': {'type': 'embedding', 'num_embeddings': 10, 'embedding_dim': 32, 'padding_idx': 0}, 'nitrogen_source': {'type': 'embedding', 'num_embeddings': 10, 'embedding_dim': 32, 'padding_idx': 0}}, 'feature_fusion': {'type': 'concat', 'fusion_dim': 256, 'hidden_dim': 128, 'num_layers': 2, 'dropout': 0.1}, 'transformer': {'num_layers': 3, 'num_heads': 4, 'hidden_dim': 128, 'dropout': 0.1, 'activation': 'gelu', 'layer_norm_eps': 1e-05}, 'prediction_head': {'type': 'mlp', 'hidden_dims': [128, 64], 'dropout': 0.1, 'activation': 'relu', 'output_dim': 1}, 'loss': {'type': 'mse', 'reduction': 'mean'}, 'optimizer': {'type': 'adam', 'lr': 0.001, 'weight_decay': 0.0001, 'betas': [0.9, 0.999], 'eps': 1e-08}, 'scheduler': {'type': 'cosine', 'T_max': 100, 'eta_min': 1e-06}}}, 'finetune': {'pretrain_checkpoint': True, 'checkpoint': 'checkpoints/fetal_pretrain_fetal_finetune/Astrocytes/checkpoint-best.pth', 'strict': False, 'model_key': 'state_dict', 'use_lora': True, 'lora_checkpoint': None, 'rename_config': None, 'layers_with_lora': ['encoder', 'head_exp'], 'patterns_to_freeze': [], 'patterns_to_drop': [], 'additional_checkpoints': []}, 'logging': {'save_dir': 'output/yeast_test_run', 'tensorboard': False, 'wandb': False, 'project_name': 'yeast_test', 'run_name': 'test_run', 'use_wandb': False}, 'machine': {'output_dir': 'output', 'num_devices': 1}, 'optimizer': {'lr': 0.0001, 'min_lr': 1e-06, 'weight_decay': 0.05, 'opt': 'adamw', 'opt_eps': 1e-08, 'opt_betas': [0.9, 0.999]}, 'task': {'test_mode': 'normal', 'interpret': False, 'save_predictions': False, 'save_embeddings': False}, 'dataset': {'_target_': 'get_model.data.yeast_dataset.YeastZarrDataset', 'zarr_path': '/home/rhyswei/Code/aiyeast/get_model/input/20250601_data/yeast_data_with_conditions_original_peaks.zarr', 'split': 'train', 'batch_size': 8, 'shuffle': True, 'num_workers': 1}}
2025-06-05 15:54:26,376 - INFO - 使用设备: cpu
2025-06-05 15:54:26,397 - INFO - 数据加载完成，批次大小: 8
2025-06-05 15:54:26,427 - INFO - 模型初始化完成
2025-06-05 15:54:27,186 - INFO - 开始训练...
2025-06-05 15:54:37,051 - INFO - Epoch 1/1, Batch 0/9, Loss: 4211444.5000
2025-06-05 15:54:46,282 - INFO - Epoch 1/1, Batch 1/9, Loss: 4907886.0000
2025-06-05 15:54:55,056 - INFO - Epoch 1/1, Batch 2/9, Loss: 6738841.5000
2025-06-05 15:55:03,598 - INFO - Epoch 1/1, Batch 3/9, Loss: 9776458.0000
2025-06-05 15:55:12,330 - INFO - Epoch 1/1, Batch 4/9, Loss: 5679772.0000
2025-06-05 15:55:21,574 - INFO - Epoch 1/1, Batch 5/9, Loss: 4748362.0000
2025-06-05 15:55:39,499 - INFO - Epoch 1/1, Batch 6/9, Loss: 10878397.0000
2025-06-05 15:55:48,989 - INFO - Epoch 1/1, Batch 7/9, Loss: 3084216.2500
2025-06-05 15:55:41,111 - INFO - Epoch 1/1, Batch 8/9, Loss: 10948533.0000
2025-06-05 15:55:41,134 - INFO - Epoch 1/1, Average Loss: 6774878.9167
2025-06-05 15:55:41,157 - INFO - Model saved to output/yeast_test_run/model_epoch_1.pth
2025-06-05 15:55:41,180 - INFO - Final model saved to output/yeast_test_run/final_model.pth

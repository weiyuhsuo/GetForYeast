2025-06-05 14:24:04,369 - INFO - 开始训练，配置：
{'stage': 'fit', 'type': 'region', 'assembly': 'hg38', 'eval_tss': False, 'log_image': False, 'experiment': {'name': 'yeast_lora_finetuning', 'seed': 42, 'debug': True}, 'training': {'batch_size': 8, 'num_workers': 1, 'learning_rate': 0.0001, 'weight_decay': 0.0001, 'max_epochs': 1, 'early_stopping_patience': 2, 'gradient_clip_val': 1.0, 'use_lora': True, 'lora_rank': 2, 'lora_alpha': 8, 'lora_layers': ['encoder', 'head_exp'], 'save_every_n_epochs': 1, 'accumulate_grad_batches': 1, 'clip_grad': None, 'use_fp16': False, 'log_every_n_steps': 1, 'val_check_interval': 1.0, 'warmup_epochs': 0}, 'data': {'data_path': '/home/rhyswei/Code/aiyeast/get_model/input/20250601_data/yeast_data_with_conditions_original_peaks.zarr'}, 'model': {'_target_': 'get_model.model.yeast_model.YeastModel', 'cfg': {'num_regions': 2268, 'num_motif': 283, 'embed_dim': 256, 'num_layers': 3, 'num_heads': 8, 'dropout': 0.1, 'output_dim': 1, 'flash_attn': False, 'pool_method': 'mean', 'region_embed': {'num_regions': '${model.cfg.num_regions}', 'num_features': '${model.cfg.num_motif}', 'embed_dim': '${model.cfg.embed_dim}'}, 'encoder': {'num_heads': '${model.cfg.num_heads}', 'embed_dim': '${model.cfg.embed_dim}', 'num_layers': '${model.cfg.num_layers}', 'drop_path_rate': '${model.cfg.dropout}', 'drop_rate': 0, 'attn_drop_rate': 0, 'use_mean_pooling': False, 'flash_attn': '${model.cfg.flash_attn}'}, 'head_exp': {'embed_dim': '${model.cfg.embed_dim}', 'output_dim': '${model.cfg.output_dim}', 'use_atac': False}, 'loss': {'components': {'exp': {'_target_': 'torch.nn.PoissonNLLLoss', 'reduction': 'mean', 'log_input': False}}, 'weights': {'exp': 1.0}}, 'metrics': {'components': {'exp': ['pearson', 'spearman', 'r2']}}}, 'model': {'name': 'yeast_model', 'type': 'transformer', 'feature_encoders': {'media_type': {'type': 'embedding', 'num_embeddings': 2, 'embedding_dim': 32, 'padding_idx': None}, 'temperature': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'pre_culture': {'time': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'od600': {'type': 'linear', 'in_features': 1, 'out_features': 32}}, 'drug_culture': {'time': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'drug_name': {'type': 'embedding', 'num_embeddings': 100, 'embedding_dim': 32, 'padding_idx': 0}, 'concentration': {'type': 'linear', 'in_features': 1, 'out_features': 32}}, 'carbon_source': {'type': 'embedding', 'num_embeddings': 10, 'embedding_dim': 32, 'padding_idx': 0}, 'nitrogen_source': {'type': 'embedding', 'num_embeddings': 10, 'embedding_dim': 32, 'padding_idx': 0}}, 'feature_fusion': {'type': 'concat', 'fusion_dim': 256, 'hidden_dim': 128, 'num_layers': 2, 'dropout': 0.1}, 'transformer': {'num_layers': 3, 'num_heads': 4, 'hidden_dim': 128, 'dropout': 0.1, 'activation': 'gelu', 'layer_norm_eps': 1e-05}, 'prediction_head': {'type': 'mlp', 'hidden_dims': [128, 64], 'dropout': 0.1, 'activation': 'relu', 'output_dim': 1}, 'loss': {'type': 'mse', 'reduction': 'mean'}, 'optimizer': {'type': 'adam', 'lr': 0.001, 'weight_decay': 0.0001, 'betas': [0.9, 0.999], 'eps': 1e-08}, 'scheduler': {'type': 'cosine', 'T_max': 100, 'eta_min': 1e-06}}}, 'finetune': {'pretrain_checkpoint': True, 'checkpoint': 'checkpoints/regulatory_inference_checkpoint_fetal_adult/pretrain_fetal_adult/checkpoint-799.pth', 'strict': False, 'model_key': 'state_dict', 'use_lora': True, 'lora_checkpoint': None, 'rename_config': None, 'layers_with_lora': ['encoder', 'head_exp'], 'patterns_to_freeze': [], 'patterns_to_drop': [], 'additional_checkpoints': []}, 'logging': {'save_dir': 'output/yeast_test_run', 'tensorboard': False, 'wandb': False, 'project_name': 'yeast_test', 'run_name': 'test_run', 'use_wandb': False}, 'machine': {'output_dir': 'output', 'num_devices': 1}, 'optimizer': {'lr': 0.0001, 'min_lr': 1e-06, 'weight_decay': 0.05, 'opt': 'adamw', 'opt_eps': 1e-08, 'opt_betas': [0.9, 0.999]}, 'task': {'test_mode': 'normal', 'interpret': False, 'save_predictions': False, 'save_embeddings': False}, 'dataset': {'_target_': 'get_model.data.yeast_dataset.YeastZarrDataset', 'zarr_path': '/home/rhyswei/Code/aiyeast/get_model/input/20250601_data/yeast_data_with_conditions_original_peaks.zarr', 'split': 'train', 'batch_size': 8, 'shuffle': True, 'num_workers': 1}}
2025-06-05 14:24:04,373 - INFO - 使用设备: cpu
2025-06-05 14:24:04,415 - INFO - 数据加载完成，批次大小: 8
2025-06-05 14:24:04,446 - INFO - 模型初始化完成
2025-06-05 14:24:06,784 - INFO - 开始训练...
2025-06-05 14:24:07,283 - INFO - Epoch 1/1, Batch 0/9, Loss: 7550358.5000
2025-06-05 14:24:07,607 - INFO - Epoch 1/1, Batch 1/9, Loss: 6481876.5000
2025-06-05 14:24:07,876 - INFO - Epoch 1/1, Batch 2/9, Loss: 7964460.0000
2025-06-05 14:24:07,668 - INFO - Epoch 1/1, Batch 3/9, Loss: 7782238.5000
2025-06-05 14:24:07,922 - INFO - Epoch 1/1, Batch 4/9, Loss: 4007435.2500
2025-06-05 14:24:08,293 - INFO - Epoch 1/1, Batch 5/9, Loss: 3789673.2500
2025-06-05 14:24:08,551 - INFO - Epoch 1/1, Batch 6/9, Loss: 9187729.0000
2025-06-05 14:24:08,823 - INFO - Epoch 1/1, Batch 7/9, Loss: 4044264.0000
2025-06-05 14:24:08,889 - INFO - Epoch 1/1, Batch 8/9, Loss: 7839113.0000
2025-06-05 14:24:08,901 - INFO - Epoch 1/1, Average Loss: 6516349.7778
2025-06-05 14:24:08,917 - INFO - 保存检查点到: output/yeast_test_run/checkpoint_epoch_1.pth
2025-06-05 14:24:08,920 - INFO - 训练完成，最终模型保存到: output/yeast_test_run/final_model.pth
2025-06-05 14:25:58,259 - INFO - 开始训练，配置：
{'stage': 'fit', 'type': 'region', 'assembly': 'hg38', 'eval_tss': False, 'log_image': False, 'experiment': {'name': 'yeast_lora_finetuning', 'seed': 42, 'debug': True}, 'training': {'batch_size': 8, 'num_workers': 1, 'learning_rate': 0.0001, 'weight_decay': 0.0001, 'max_epochs': 1, 'early_stopping_patience': 2, 'gradient_clip_val': 1.0, 'use_lora': True, 'lora_rank': 2, 'lora_alpha': 8, 'lora_layers': ['encoder', 'head_exp'], 'save_every_n_epochs': 1, 'accumulate_grad_batches': 1, 'clip_grad': None, 'use_fp16': False, 'log_every_n_steps': 1, 'val_check_interval': 1.0, 'warmup_epochs': 0}, 'data': {'data_path': '/home/rhyswei/Code/aiyeast/get_model/input/20250601_data/yeast_data_with_conditions_original_peaks.zarr'}, 'model': {'_target_': 'get_model.model.yeast_model.YeastModel', 'cfg': {'num_regions': 2268, 'num_motif': 283, 'embed_dim': 256, 'num_layers': 3, 'num_heads': 8, 'dropout': 0.1, 'output_dim': 1, 'flash_attn': False, 'pool_method': 'mean', 'region_embed': {'num_regions': '${model.cfg.num_regions}', 'num_features': '${model.cfg.num_motif}', 'embed_dim': '${model.cfg.embed_dim}'}, 'encoder': {'num_heads': '${model.cfg.num_heads}', 'embed_dim': '${model.cfg.embed_dim}', 'num_layers': '${model.cfg.num_layers}', 'drop_path_rate': '${model.cfg.dropout}', 'drop_rate': 0, 'attn_drop_rate': 0, 'use_mean_pooling': False, 'flash_attn': '${model.cfg.flash_attn}'}, 'head_exp': {'embed_dim': '${model.cfg.embed_dim}', 'output_dim': '${model.cfg.output_dim}', 'use_atac': False}, 'loss': {'components': {'exp': {'_target_': 'torch.nn.PoissonNLLLoss', 'reduction': 'mean', 'log_input': False}}, 'weights': {'exp': 1.0}}, 'metrics': {'components': {'exp': ['pearson', 'spearman', 'r2']}}}, 'model': {'name': 'yeast_model', 'type': 'transformer', 'feature_encoders': {'media_type': {'type': 'embedding', 'num_embeddings': 2, 'embedding_dim': 32, 'padding_idx': None}, 'temperature': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'pre_culture': {'time': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'od600': {'type': 'linear', 'in_features': 1, 'out_features': 32}}, 'drug_culture': {'time': {'type': 'linear', 'in_features': 1, 'out_features': 32}, 'drug_name': {'type': 'embedding', 'num_embeddings': 100, 'embedding_dim': 32, 'padding_idx': 0}, 'concentration': {'type': 'linear', 'in_features': 1, 'out_features': 32}}, 'carbon_source': {'type': 'embedding', 'num_embeddings': 10, 'embedding_dim': 32, 'padding_idx': 0}, 'nitrogen_source': {'type': 'embedding', 'num_embeddings': 10, 'embedding_dim': 32, 'padding_idx': 0}}, 'feature_fusion': {'type': 'concat', 'fusion_dim': 256, 'hidden_dim': 128, 'num_layers': 2, 'dropout': 0.1}, 'transformer': {'num_layers': 3, 'num_heads': 4, 'hidden_dim': 128, 'dropout': 0.1, 'activation': 'gelu', 'layer_norm_eps': 1e-05}, 'prediction_head': {'type': 'mlp', 'hidden_dims': [128, 64], 'dropout': 0.1, 'activation': 'relu', 'output_dim': 1}, 'loss': {'type': 'mse', 'reduction': 'mean'}, 'optimizer': {'type': 'adam', 'lr': 0.001, 'weight_decay': 0.0001, 'betas': [0.9, 0.999], 'eps': 1e-08}, 'scheduler': {'type': 'cosine', 'T_max': 100, 'eta_min': 1e-06}}}, 'finetune': {'pretrain_checkpoint': True, 'checkpoint': 'checkpoints/regulatory_inference_checkpoint_fetal_adult/pretrain_fetal_adult/checkpoint-799.pth', 'strict': False, 'model_key': 'state_dict', 'use_lora': True, 'lora_checkpoint': None, 'rename_config': None, 'layers_with_lora': ['encoder', 'head_exp'], 'patterns_to_freeze': [], 'patterns_to_drop': [], 'additional_checkpoints': []}, 'logging': {'save_dir': 'output/yeast_test_run', 'tensorboard': False, 'wandb': False, 'project_name': 'yeast_test', 'run_name': 'test_run', 'use_wandb': False}, 'machine': {'output_dir': 'output', 'num_devices': 1}, 'optimizer': {'lr': 0.0001, 'min_lr': 1e-06, 'weight_decay': 0.05, 'opt': 'adamw', 'opt_eps': 1e-08, 'opt_betas': [0.9, 0.999]}, 'task': {'test_mode': 'normal', 'interpret': False, 'save_predictions': False, 'save_embeddings': False}, 'dataset': {'_target_': 'get_model.data.yeast_dataset.YeastZarrDataset', 'zarr_path': '/home/rhyswei/Code/aiyeast/get_model/input/20250601_data/yeast_data_with_conditions_original_peaks.zarr', 'split': 'train', 'batch_size': 8, 'shuffle': True, 'num_workers': 1}}
2025-06-05 14:25:58,260 - INFO - 使用设备: cpu
2025-06-05 14:25:58,282 - INFO - 数据加载完成，批次大小: 8
2025-06-05 14:25:58,287 - INFO - 模型初始化完成
2025-06-05 14:25:59,633 - INFO - 开始训练...
2025-06-05 14:25:59,989 - INFO - Epoch 1/1, Batch 0/9, Loss: 7550358.5000
2025-06-05 14:26:00,262 - INFO - Epoch 1/1, Batch 1/9, Loss: 6481876.5000
2025-06-05 14:26:00,582 - INFO - Epoch 1/1, Batch 2/9, Loss: 7964460.0000
2025-06-05 14:26:00,890 - INFO - Epoch 1/1, Batch 3/9, Loss: 7782238.5000
2025-06-05 14:26:01,200 - INFO - Epoch 1/1, Batch 4/9, Loss: 4007435.2500
2025-06-05 14:26:01,464 - INFO - Epoch 1/1, Batch 5/9, Loss: 3789673.2500
2025-06-05 14:26:01,712 - INFO - Epoch 1/1, Batch 6/9, Loss: 9187729.0000
2025-06-05 14:26:01,974 - INFO - Epoch 1/1, Batch 7/9, Loss: 4044264.0000
2025-06-05 14:26:02,040 - INFO - Epoch 1/1, Batch 8/9, Loss: 7839113.0000
2025-06-05 14:26:02,055 - INFO - Epoch 1/1, Average Loss: 6516349.7778
2025-06-05 14:26:02,065 - INFO - 保存检查点到: output/yeast_test_run/checkpoint_epoch_1.pth
2025-06-05 14:26:02,070 - INFO - 训练完成，最终模型保存到: output/yeast_test_run/final_model.pth
